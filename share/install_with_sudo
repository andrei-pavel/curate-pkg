#!/bin/bash

# Copyright (C) 2017-2018 Andrei Pavel, andrei.pavel@cti.pub.ro
# Licensed under the MIT License

# Get script path and append it to PATH so other scripts are callable.
SCRIPT_PATH="$(dirname "$(readlink -f "${0}")")"
PATH="${PATH}:${SCRIPT_PATH}"

# Header
ARGUMENTS="\
  [-p|--prefix] \$prefix        sets the \${pkgdir} used for AUR PKGBUILD
"
. "${SCRIPT_PATH}/header"

# Parse arguments.
pkgdir=
while (( ${#} > 0 )); do
  case "${1}" in
  # [-p|--prefix] \$prefix        sets the \${pkgdir} used for AUR PKGBUILD
  '-p'|'--prefix') shift && pkgdir="${1}";;
  *)
    # Unrecognized argument
    printf "${RED}ERROR: Unrecognized argument '%s'${RESET}\\n" "${1}" 1>&2; printUsage; exit 1;;
  esac; shift
done


#------------------------------------------------------------------------------#

pushd "${SCRIPT_PATH}" 1> /dev/null
{
  # Install.
  mkdir -p "${pkgdir}/usr/local/bin"
  install ../bin/* "${pkgdir}/usr/local/bin"
  mkdir -p "${pkgdir}/usr/local/share/curate-pkg/samples"
  mkdir -p "${pkgdir}/usr/local/share/curate-pkg/package-managers"
  install ./header "${pkgdir}/usr/local/share/curate-pkg"
  install ./spinner "${pkgdir}/usr/local/share/curate-pkg"
  install ./*.yaml "${pkgdir}/usr/local/share/curate-pkg"
  install ./package-managers/*.sh "${pkgdir}/usr/local/share/curate-pkg/package-managers"
  install ./samples/* "${pkgdir}/usr/local/share/curate-pkg/samples"

  # Install bash_completions.
  set +e
  bash_completions="$(pkg-config --variable=completionsdir bash-completion)"
  result="${?}"
  set -e
  if (( result != 0 )); then
    bash_completions='/usr/share/bash-completion/completions'
  fi
  install ./bash-completion "${pkgdir}/${bash_completions}/curate-pkg"

  # Install yq if not already installed.
  if ! command -v yq &> /dev/null; then
    pip install ./yq-2.3.4-py2.py3-none-any.whl
  fi
}
popd 1> /dev/null
